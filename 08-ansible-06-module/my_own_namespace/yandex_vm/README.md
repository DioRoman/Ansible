# Ansible Collection - my_own_namespace.yandex_vm

# Модуль Ansible для создания ВМ в Yandex Cloud через CLI

**Версия:** 1.0.0  
**Автор:** Roman Lystsev  
**Лицензия:** MIT

## Описание

Ansible-модуль предназначен для **создания виртуальной машины (ВМ) в Yandex Cloud** с помощью CLI (`yc compute instance create`). Модуль проверяет, существует ли ВМ с заданным именем (идемпотентность), и создаёт её только если она отсутствует. Позволяет настраивать основные параметры новой ВМ: имя, зону, ресурсы, загрузочный образ, размер диска и путь к SSH-ключу.

## Аргументы

| Параметр      | Описание                                           | Тип    | Обязателен | Значение по умолчанию |
|---------------|----------------------------------------------------|--------|------------|----------------------|
| folder_id     | Идентификатор папки, в которой создаётся ВМ        | str    | да         | —                    |
| zone          | Зона размещения ВМ                                 | str    | нет        | ru-central1-a        |
| vm_name       | Имя виртуальной машины                             | str    | да         | —                    |
| core_count    | Количество vCPU                                    | int    | нет        | 2                    |
| memory_gb     | Объём памяти (ГБ)                                  | int    | нет        | 4                    |
| image_id      | ID образа (image-id) для загрузочного диска        | str    | да         | —                    |
| disk_size_gb  | Размер загрузочного диска (ГБ)                     | int    | нет        | 20                   |
| ssh_key_path  | Путь к публичному SSH-ключу                        | path   | да         | —                    |

## Пример использования
```
name: Создать ВМ в Yandex Cloud
my_namespace.my_collection.yc_vm_create:
folder_id: "b1gvmob95yys****"
zone: "ru-central1-a"
vm_name: "test-vm"
core_count: 2
memory_gb: 4
image_id: "fd8etj844cv1jee6c9lb"
disk_size_gb: 40
ssh_key_path: "/home/ansible/.ssh/id_rsa.pub"
```
## Возвращаемые значения

| Значение  | Описание                                              | Тип   | Всегда возвращается |
|-----------|-------------------------------------------------------|-------|---------------------|
| changed   | Было ли внесено изменение (создана новая ВМ)          | bool  | да                  |
| msg       | Краткое сообщение о результате                        | str   | да                  |
| output    | Вывод yc CLI при успешном создании                    | str   | да (при success)    |
| error     | Сообщение об ошибке yc CLI                            | str   | да (при fail)       |

## Особенности

- Модуль не изменяет существующую ВМ — если ВМ с таким именем существует, выполнение будет идемпотентным (changed=False).
- Путь к SSH-ключу должен быть валидным и доступным для чтения.
- При ошибках CLI (yc) возвращается подробное сообщение об ошибке.
- Позволяет создавать только прерываемые (preemptible) ВМ (можно убрать/раскрыть опцию при необходимости).
- Не поддерживает check mode.

# Требования для работы модуля создания ВМ в Yandex Cloud

## Необходимые компоненты и окружение

- **Yandex Cloud CLI (`yc`):**
  - Установлен официальный CLI-клиент Yandex Cloud версии не ниже 1.x.
  - Выполнена инициализация: настроен профиль и аутентификация (`yc init`).
  - Проверена работоспособность командой `yc compute instance list`.

- **Ansible:**
  - Установлен на машине управления (Linux или macOS).
  - Версия Ansible ≥ 2.9 рекомендуется для корректной работы с Python 3.

- **Python 3:**
  - Модуль требует интерпретатор Python 3.
  - Должны быть доступны стандартные библиотеки: `os`, `subprocess`, `json`, а также модуль `ansible.module_utils`.

- **Права доступа (IAM):**
  - Сервисный аккаунт или пользователь, под которым работает CLI, должен обладать правами на создание и управление ВМ в указанной папке (`compute.editor` или шире)[1][3].
  - Доступ к созданию ресурсов в VPC, а также просмотру данных о сетях и подсетях.

- **SSH-ключ:**
  - Необходим действующий публичный SSH-ключ (файл `.pub`), путь передаётся параметром `ssh_key_path`.
  - Ключ должен быть читаемым для пользователя Ansible.

- **Интернет-доступ:**
  - Нужен стабильный доступ до публичных API Yandex Cloud из среды запуска Ansible.

## Требования к инфраструктуре Yandex Cloud

- **VPC-сеть и подсети должны быть созданы заранее:**
  - Для развертывания ВМ требуется заранее созданная VPC-сеть (`yc vpc network create`).
  - Должны быть предварительно созданы одна или несколько подсетей (`yc vpc subnet create`), соответствующие нужным зонам доступности.
  - Рекомендация: убедитесь, что подсети охватывают требуемые зоны, а в свойствах указаны правильные маршруты и диапазоны адресов.

- **Параметры запуска ВМ должны ссылаться на существующие VPC и Subnet ID.**

---

## Сводка требований

- Yandex Cloud CLI (`yc`) инициализирован и работает.
- Ansible и Python 3 доступны на машине управления.
- Профиль CLI настроен для нужной папки (`folder_id`) и зоны.
- Созданы VPC-сеть и хотя бы одна подсеть для размещения ВМ.
- Присутствует публичный SSH-ключ, указанный в параметре `ssh_key_path`.
- Аккаунт (или сервисный аккаунт) обладает достаточными правами доступа.
- Есть соединение с интернетом до сервисов Yandex Cloud.

> Перед использованием модуля обязательно подготовьте все облачные ресурсы сети и доступа. Если требуется автоматизация создания VPC и Subnet — используйте отдельные playbook или команды CLI за пределами этого модуля.

---
